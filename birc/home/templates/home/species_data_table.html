{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags static i18n %}

{% block content %}

<section class="dataset-header pt-5 bg_black">
  <div class="container-xl">
    <h1 class="text-dark full-width">{{ page.title }}</h1>
    <p class="text-dark">{{ page.description|safe }}</p>
  </div>
</section>

<!-- Gallery Section -->
{% if page.gallery_images.all %}
<section class="dataset-gallery py-5 bg_black">
  <div class="container-xl">
        
    <div class="blog_1 row row-cols-1 row-cols-md-3">
      {% for img in page.gallery_images.all %}
            <div class="col">
                <div class="blog_1_left rounded_10 p-3 shadow bg_black">
                        {% if img.image %}
                         
                            {% image img.image fill-500x350 class="img-fluid rounded_10" %}
                         
                        {% endif %}
          
         
          
                        {% if img.caption %}
                            <h5 class="text-dark py-3">{{ img.caption }}</h5>        
                            <p class="text-dark">{{ img.intro|richtext|striptags|truncatechars:120 }}</p>        
                        {% endif %}
                        
                        <div class="py-0">
                              {% if img.pagelink %}
                                    <a class="button button_2" href="{{ img.pagelink.url }}">
                                      Read More <i class="bi-arrow-right-square-fill ms-1"></i>
                                    </a>     
                              {% else %}      
                                    <a class="button button_2" href="#">
                                      Read More <i class="bi-arrow-right-square-fill ms-1"></i>
                                    </a>
                              {% endif %}
                        </div>
                </div>
             </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}


 

<section class="dataset-table pt-3">
  <div class="container-xl">

    {% if page.columns and page.rows.all %}
      <!-- Search Input -->
      <div style="margin-bottom: 15px;">
        <input 
            type="text" 
            id="tableSearch" 
            placeholder="Search table data..." 
            style="width: 100%; padding: 10px; background-color: #f9f9f9; color: #333; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;"
        >
        <p style="margin-top: 8px; color: #666; font-size: 12px;">
            Search across all columns. Results update as you type.
        </p>
      </div>

      <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
        <table id="speciesTable" class="listing w-100 border_light">
          <thead>
            <tr>
              <th class="sticky-header bg_green">#</th>
              {% for col in page.columns %}
                <th class="sticky-header bg_green">
                  {{ col }}
                </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody id="tableBody">
            {% for row in page.rows.all %}
              <tr class="data-row">
                <td class="p-2 border_light bg-white text-dark font_14">{{ forloop.counter }}</td>
                {% for cell in row.cells %}
                  <td class="p-2 border_light bg-white text-dark font_14">
                    {{ cell }}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <style>
          .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--green) !important;
            color: white !important;
            padding: 10px;
            border: 1px solid var(--border_light);
            font-weight: bold;
            z-index: 100;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
          }
          #speciesTable tbody tr:hover {
            background-color: #dadada;          
          }
          #speciesTable tbody td {
            background-color: #ffffff !important;
            border: 1px solid var(--green); /* Matches your green theme */
          }
        </style>
      </div>

      <div style="margin-top: 5px; display: flex; justify-content: space-between; align-items: center;">
        <p style="color: #666; margin: 0; padding-bottom: 10px; font-size: 11px;">
          <strong>Total rows:</strong> <span id="totalRows">{{ page.rows.count }}</span>
        </p>
        <p style="color: #666; margin: 0; padding-bottom: 10px; font-size: 11px;">
          <strong>Showing:</strong> <span id="visibleRows">{{ page.rows.count }}</span> rows
        </p>
      </div>

      <!-- Search JS -->
      <script>
      (function() {
          var searchInput = document.getElementById('tableSearch');
          var tableBody = document.getElementById('tableBody');
          var rows = tableBody.getElementsByClassName('data-row');
          var visibleRowsSpan = document.getElementById('visibleRows');

          searchInput.addEventListener('input', function() {
              var searchTerm = this.value.toLowerCase();
              var visibleCount = 0;

              for (var i = 0; i < rows.length; i++) {
                  var row = rows[i];
                  var cells = row.getElementsByTagName('td');
                  var found = false;

                  for (var j = 1; j < cells.length; j++) {  // skip row number
                      if (cells[j].innerText.toLowerCase().includes(searchTerm)) {
                          found = true;
                          break;
                      }
                  }

                  row.style.display = found || searchTerm === '' ? '' : 'none';
                  if (found || searchTerm === '') visibleCount++;
              }

              visibleRowsSpan.textContent = visibleCount;
          });
      })();
      </script>

    {% else %}
      <p style="padding: 20px; background-color: #2d2d2d; border: 1px solid #444; border-radius: 4px; color: #ffffff;">
        {% trans "No data available for this species collection." %}
      </p>
    {% endif %}

  </div>


</section>

{% endblock %}
